@model CosmeticStore.MVC.Models.Order

@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.OrderId;
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Chi tiết đơn hàng #@Model.OrderId</h2>
        <a asp-action="Index" class="btn btn-secondary">Quay lại danh sách</a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white fw-bold">Thông tin khách hàng</div>
                <div class="card-body">
                    <p><strong>Họ tên:</strong> @Model.CustomerName</p>
                    <p><strong>SĐT:</strong> @Model.CustomerPhone</p>
                    <p><strong>Địa chỉ:</strong> @Model.ShippingAddress</p>
                    <p><strong>Ngày đặt:</strong> @Model.OrderDate?.ToString("dd/MM/yyyy HH:mm")</p>

                   

                    <hr />

                    <div class="mb-3 text-center">
                        <label class="form-label d-block text-muted small">Trạng thái đơn hàng</label>
                        @if (Model.Status == "Pending")
                        {
                            <span class="badge bg-warning text-dark fs-5 px-4 py-2">Chờ xử lý</span>
                        }
                        @if (Model.Status == "Paid")
                        {
                            <span class="badge bg-warning text-dark fs-5 px-4 py-2">Đơn hàng đã thanh toán</span>
                        }
                        else if (Model.Status == "Processing")
                        {
                            <span class="badge bg-info text-white fs-5 px-4 py-2">Đang đóng gói</span>
                        }
                        else if (Model.Status == "Shipped")
                        {
                            <span class="badge bg-primary fs-5 px-4 py-2">Đang giao hàng</span>
                        }
                        else if (Model.Status == "Completed")
                        {
                            <span class="badge bg-success fs-5 px-4 py-2">Hoàn thành</span>
                        }
                        else if (Model.Status == "Cancelled")
                        {
                            <span class="badge bg-danger fs-5 px-4 py-2">Đã hủy</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary fs-5 px-4 py-2">@Model.Status</span>
                        }
                    </div>

                    <hr />

                    <div class="mb-3 text-center">
                        <label class="form-label fw-bold d-block">Hành động:</label>
                        <div class="d-flex flex-column gap-2">
                            @{
                                string nextStatus = "";
                                string nextStatusText = "";
                                string nextStatusClass = "btn-primary";
                            }

                            @if (Model.Status == "Pending" || Model.Status == "Paid")
                            {
                                nextStatus = "Processing";
                                nextStatusText = "Chuyển sang Đang đóng gói";
                            }
                            else if (Model.Status == "Processing")
                            {
                                nextStatus = "Shipped";
                                nextStatusText = "Chuyển sang Đang giao hàng";
                            }
                            else if (Model.Status == "Shipped")
                            {
                                nextStatus = "Completed";
                                nextStatusText = "Đánh dấu Hoàn thành";
                                nextStatusClass = "btn-success";
                            }

                            @if (!string.IsNullOrEmpty(nextStatus))
                            {
                                <form asp-action="UpdateStatus" method="post" onsubmit="return confirm('Bạn có chắc muốn chuyển trạng thái đơn hàng sang @nextStatusText không?');">
                                    <input type="hidden" name="id" value="@Model.OrderId" />
                                    <input type="hidden" name="status" value="@nextStatus" />
                                    <button type="submit" class="btn @nextStatusClass w-100 fw-bold py-2">
                                        @nextStatusText
                                    </button>
                                </form>
                            }

                            @if (Model.Status != "Completed" && Model.Status != "Cancelled")
                            {
                                <hr class="my-1" />
                                <form asp-action="UpdateStatus" method="post" onsubmit="return confirm('CẢNH BÁO: Việc hủy đơn sẽ hoàn lại số lượng sản phẩm vào kho. Bạn có chắc chắn muốn HỦY ĐƠN HÀNG này không?');">
                                    <input type="hidden" name="id" value="@Model.OrderId" />
                                    <input type="hidden" name="status" value="Cancelled" />
                                    <button type="submit" class="btn btn-outline-danger w-100 fw-bold py-2">
                                        Hủy đơn & Hoàn kho
                                    </button>
                                </form>

                                <div class="form-text text-danger mt-2 small text-start">
                                    Lưu ý: Thao tác này sẽ cập nhật lại số lượng tồn kho.
                                </div>
                            }
                            else if (string.IsNullOrEmpty(nextStatus))
                            {
                                <div class="alert alert-light text-center border mt-2 py-3 small">
                                    Đơn hàng đã @(Model.Status == "Completed" ? "Hoàn thành" : "bị Hủy"). Không thể cập nhật thêm.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-dark text-white fw-bold">Sản phẩm đã mua</div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Đơn giá</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.OrderDetails)
                        {
                            var product = item.Variant?.Product;
                            var variantName = item.Variant?.VariantName;

                            <tr>
                                <td>
                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product?.ProductId"
                                       class="d-flex align-items-center text-decoration-none text-dark">
                                        <img src="@(product?.MainImageUrl ?? "https://via.placeholder.com/50")"
                                             width="50" height="50" style="object-fit:cover" class="me-2 border rounded" />
                                        <div>
                                            <span class="fw-bold">@product?.ProductName</span>
                                            <br />
                                            <small class="text-muted">Phân loại: @variantName</small>
                                        </div>
                                    </a>
                                </td>
                                <td>@item.UnitPrice.ToString("#,##0") đ</td>
                                <td>x @item.Quantity</td>
                                <td class="fw-bold text-danger">
                                    @((item.Quantity * item.UnitPrice).ToString("#,##0")) đ
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="bg-light">
                        <tr>
                            <td colspan="3" class="text-end fw-bold">TỔNG CỘNG:</td>
                            <td class="fw-bold text-danger fs-5">@Model.TotalAmount.ToString("#,##0") đ</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>