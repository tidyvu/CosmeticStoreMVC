@using CosmeticStore.MVC.Helpers
@model PaginatedList<CosmeticStore.MVC.Models.Product>

@{
    ViewData["Title"] = "Mua sắm";
    var categories = ViewBag.Categories as List<CosmeticStore.MVC.Models.Category>;
    var brands = ViewBag.Brands as List<CosmeticStore.MVC.Models.Brand>;

    // Định nghĩa tông màu
    string brandRed = "#d14d5a";    // Đỏ San Hô đậm
    string lightPink = "#f7e6e9";   // Hồng Nhạt
}

<style>
    /* ------------------------------------------------------------------ */
    /* CSS TÙY CHỈNH THEO TÔNG ĐỎ SAN HÔ */
    /* ------------------------------------------------------------------ */

    /* --- Nút và Màu sắc chung --- */
    .text-custom-primary {
        color: @brandRed !important;
    }

    .btn-primary-custom {
        background-color: @brandRed !important;
        border-color: @brandRed !important;
        color: white;
    }

        .btn-primary-custom:hover {
            background-color: #b03d47 !important;
            border-color: #b03d47 !important;
        }

    .list-group-item.active-custom {
        color: @brandRed !important;
        font-weight: bold;
        background-color: #fff;
        border-left: 3px solid @brandRed;
    }

    /* --- Grid & Card Sản Phẩm --- */
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
    }

    .product-card {
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        transition: box-shadow 0.3s;
        background: #fff;
        height: 100%; /* Đảm bảo card cao hết khung */
        display: flex;
        flex-direction: column;
    }

        .product-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

    /* Khung ảnh vuông */
    .product-img-wrap {
        position: relative;
        width: 100%;
        padding-top: 100%; /* Tỉ lệ 1:1 */
        overflow: hidden;
        display: block;
    }

        .product-img-wrap img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

    .product-card:hover .product-img-wrap img {
        transform: scale(1.05);
    }

    /* Phần thông tin bên dưới ảnh */
    .product-info {
        padding: 15px;
        text-align: center;
        flex-grow: 1; /* Đẩy nội dung lấp đầy khoảng trống */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Căn nút xuống đáy */
    }

    .product-brand {
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .product-name {
        font-weight: 600;
        color: #333;
        display: block;
        margin-bottom: 8px;
        text-decoration: none;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 42px; /* Giữ khung cho tên 2 dòng */
    }

        .product-name:hover {
            color: @brandRed;
        }

    .product-price {
        color: @brandRed;
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 15px;
    }

    /* --- Các loại nút bấm --- */

    /* 1. Nút Thêm vào giỏ (Nền đỏ) */
    .btn-add-cart {
        background: @brandRed;
        color: white !important;
        padding: 8px 0;
        border-radius: 4px;
        font-weight: 500;
        transition: all 0.2s;
        display: block;
        width: 100%;
        border: 1px solid @brandRed;
        text-decoration: none;
    }

        .btn-add-cart:hover {
            background: #b03d47;
            border-color: #b03d47;
            transform: translateY(-2px);
        }

    /* 2. Nút Tùy chọn / Xem chi tiết (Nền trắng, viền đỏ) */
    .btn-options {
        background-color: white;
        color: @brandRed !important;
        border: 1px solid @brandRed;
    }

        .btn-options:hover {
            background-color: @brandRed;
            color: white !important;
        }

    /* 3. Nút Admin */
    .btn-admin {
        font-size: 0.8rem;
        padding: 4px 8px;
    }

    /* Pagination */
    .page-link {
        color: #333;
    }

    .page-item.active .page-link {
        background-color: @brandRed;
        border-color: @brandRed;
        color: white;
    }
</style>

<div class="container py-5">
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="mb-4">
                <h5 class="fw-bold text-uppercase mb-3 text-custom-primary" style="font-size: 1rem;">Tìm kiếm</h5>
                <form asp-action="Index" method="get" class="input-group">
                    <input type="text" name="searchString" value="@ViewData["CurrentFilter"]" class="form-control" placeholder="Tên sản phẩm...">
                    <button class="btn btn-primary-custom" type="submit"><i class="fa fa-search"></i></button>
                </form>
            </div>

            <div class="mb-4">
                <h5 class="fw-bold text-uppercase mb-3 text-custom-primary" style="font-size: 1rem;">Danh mục</h5>
                <div class="list-group list-group-flush">
                    <a asp-action="Index" class="list-group-item list-group-item-action border-0 px-0 @(ViewBag.CurrentCategory == null ? "active-custom" : "")">
                        <i class="fa fa-caret-right me-2"></i>Tất cả
                    </a>
                    @if (categories != null)
                    {
                        foreach (var c in categories)
                        {
                            <a asp-action="Index" asp-route-categoryId="@c.CategoryId"
                               class="list-group-item list-group-item-action border-0 px-0 @(ViewBag.CurrentCategory == c.CategoryId ? "active-custom" : "")">
                                <i class="fa fa-caret-right me-2"></i>@c.CategoryName
                            </a>
                        }
                    }
                </div>
            </div>

            <div class="mb-4">
                <h5 class="fw-bold text-uppercase mb-3 text-custom-primary" style="font-size: 1rem;">Thương hiệu</h5>
                <div class="list-group list-group-flush">
                    <a asp-action="Index" class="list-group-item list-group-item-action border-0 px-0 @(ViewBag.CurrentBrand == null ? "active-custom" : "")">
                        <i class="fa fa-caret-right me-2"></i>Tất cả
                    </a>
                    @if (brands != null)
                    {
                        foreach (var b in brands)
                        {
                            <a asp-action="Index" asp-route-brandId="@b.BrandId"
                               class="list-group-item list-group-item-action border-0 px-0 @(ViewBag.CurrentBrand == b.BrandId ? "active-custom" : "")">
                                <i class="fa fa-caret-right me-2"></i>@b.BrandName
                            </a>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h2 class="text-uppercase fw-bold text-custom-primary m-0" style="font-size: 1.5rem;">
                    @if (ViewBag.CurrentCategory != null)
                    {
                        <text>Danh mục</text>
                    }
                    else if (ViewBag.CurrentBrand != null)
                    {

                        <text>Thương hiệu</text>
                    }
                    else if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                    {

                        <text>Kết quả tìm kiếm</text>
                    }
                    else
                    {

                        <text>Tất cả sản phẩm</text>
                    }
                </h2>

                @if (User.IsInRole("Admin"))
                {
                    <a asp-action="Create" class="btn btn-primary-custom btn-sm shadow-sm">
                        <i class="fa fa-plus"></i> Thêm mới
                    </a>
                }
            </div>

            <div class="product-grid">
                @if (!Model.Any())
                {
                    <div class="col-12 text-center py-5 w-100">
                        <div class="mb-3"><i class="fa fa-search fa-3x text-muted"></i></div>
                        <p class="text-muted">Không tìm thấy sản phẩm phù hợp.</p>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Xóa bộ lọc</a>
                    </div>
                }
                else
                {
                    @foreach (var item in Model)
                    {
                        // Logic lấy biến thể
                        var variants = item.ProductVariants?.ToList() ?? new List<CosmeticStore.MVC.Models.ProductVariant>();
                        var firstVariant = variants.FirstOrDefault();
                        var variantCount = variants.Count;

                        // Logic ảnh
                        var imageUrl = string.IsNullOrEmpty(item.MainImageUrl)
                        ? "https://via.placeholder.com/300x300?text=No+Image"
                        : item.MainImageUrl;

                        <div class="product-card">
                            <a asp-action="Details" asp-route-id="@item.ProductId" class="product-img-wrap">
                                <img src="@imageUrl" alt="@item.ProductName" loading="lazy" />
                                @if (firstVariant != null && firstVariant.SalePrice > 0)
                                {
                                    <span class="badge bg-danger position-absolute top-0 end-0 m-2 shadow-sm">-Sale-</span>
                                }
                            </a>

                            <div class="product-info">
                                <div>
                                    @if (item.Brand != null)
                                    {
                                        <div class="product-brand">@item.Brand.BrandName</div>
                                    }

                                    <a asp-action="Details" asp-route-id="@item.ProductId" class="product-name" title="@item.ProductName">
                                        @item.ProductName
                                    </a>

                                    <div class="product-price">
                                        @if (firstVariant != null)
                                        {
                                            if (firstVariant.SalePrice > 0)
                                            {
                                                <span>@firstVariant.SalePrice.Value.ToString("#,##0") đ</span>
                                                <small class="text-muted text-decoration-line-through ms-1 fs-6 fw-normal">
                                                    @firstVariant.Price.ToString("#,##0") đ
                                                </small>
                                            }
                                            else
                                            {
                                                <span>@firstVariant.Price.ToString("#,##0") đ</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted fs-6">Liên hệ</span>
                                        }
                                    </div>
                                </div>

                                <div class="mt-2">
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <div class="d-flex justify-content-between mb-2 gap-1">
                                            <a asp-action="Edit" asp-route-id="@item.ProductId" class="btn btn-outline-primary btn-admin w-50">Sửa</a>
                                            <form asp-action="Delete" asp-route-id="@item.ProductId" method="post" class="w-50"
                                                  onsubmit="return confirm('Xóa sản phẩm này?');">
                                                <button type="submit" class="btn btn-outline-danger btn-admin w-100">Xóa</button>
                                            </form>
                                        </div>
                                    }

                                    @if (variantCount > 1)
                                    {
                                        <a asp-action="Details" asp-route-id="@item.ProductId"
                                           class="btn btn-add-cart btn-options">
                                            <i class="fa fa-list me-1"></i> Tùy chọn
                                        </a>
                                    }
                                    else if (variantCount == 1 && firstVariant != null)
                                    {
                                        <a asp-controller="Cart" asp-action="AddToCart"
                                           asp-route-productId="@item.ProductId"
                                           asp-route-variantId="@firstVariant.VariantId"
                                           class="btn btn-add-cart">
                                            <i class="fa fa-cart-plus me-1"></i> Thêm vào giỏ
                                        </a>
                                    }
                                    else
                                    {
                                        <a asp-action="Details" asp-route-id="@item.ProductId"
                                           class="btn btn-add-cart btn-options">
                                            <i class="fa fa-eye me-1"></i> Xem chi tiết
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="d-flex justify-content-center mt-5">
                @{
                    var prevDisabled = !Model.HasPreviousPage ? "disabled" : "";
                    var nextDisabled = !Model.HasNextPage ? "disabled" : "";
                }
                <nav>
                    <ul class="pagination">
                        <li class="page-item @prevDisabled">
                            <a asp-action="Index"
                               asp-route-pageNumber="@(Model.PageIndex - 1)"
                               asp-route-searchString="@ViewData["CurrentFilter"]"
                               asp-route-categoryId="@ViewBag.CurrentCategory"
                               asp-route-brandId="@ViewBag.CurrentBrand"
                               class="page-link shadow-none">
                                &laquo; Trước
                            </a>
                        </li>
                        <li class="page-item active">
                            <span class="page-link shadow-none">@Model.PageIndex / @Model.TotalPages</span>
                        </li>
                        <li class="page-item @nextDisabled">
                            <a asp-action="Index"
                               asp-route-pageNumber="@(Model.PageIndex + 1)"
                               asp-route-searchString="@ViewData["CurrentFilter"]"
                               asp-route-categoryId="@ViewBag.CurrentCategory"
                               asp-route-brandId="@ViewBag.CurrentBrand"
                               class="page-link shadow-none">
                                Sau &raquo;
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>