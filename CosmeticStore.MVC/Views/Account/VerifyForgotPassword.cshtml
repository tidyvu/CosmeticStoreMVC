@{
    ViewData["Title"] = "Xác thực bảo mật";
    Layout = "_Layout";
}

<div class="container d-flex justify-content-center align-items-center min-vh-100 bg-light">

    <div class="card border-0 shadow-lg rounded-4 overflow-hidden" style="max-width: 450px; width: 100%;">
        <div class="card-body p-5 text-center">

            <div class="mb-4">
                <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle" style="width: 80px; height: 80px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-envelope-check-fill" viewBox="0 0 16 16">
                        <path d="M.178 4.258l7.822 4.135 7.822-4.135a.5.5 0 0 0-.256-.904l-7.566 4-7.567-4A.5.5 0 0 0 .178 4.258zM0 6.375v7.125a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5V6.375l-8 4.228-8-4.228z" />
                        <path d="M11.46.146A.5.5 0 0 0 11.107 0H4.893a.5.5 0 0 0-.353.146L.146 4.546a.5.5 0 0 0 0 .708l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 0-.708L11.46.146z" />
                    </svg>
                </div>
            </div>

            <h3 class="fw-bold text-dark mb-2">Xác thực OTP</h3>
            <p class="text-secondary mb-4 small">
                Nhập mã 6 số chúng tôi vừa gửi đến email:<br />
                <span class="fw-bold text-dark">@ViewBag.Email</span>
            </p>

            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger d-flex align-items-center p-2 mb-4 small fade show" role="alert">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <div>@ViewBag.Error</div>
                </div>
            }

            <form asp-action="VerifyForgotPassword" method="post" id="otpForm">

                <input type="hidden" name="email" value="@ViewBag.Email" />

                <div class="mb-4 position-relative">
                    <label class="form-label visually-hidden">Mã OTP</label>
                    <input type="text"
                           name="otp"
                           class="form-control form-control-lg text-center fw-bold otp-input"
                           placeholder="------"
                           maxlength="6"
                           pattern="\d*"
                           autocomplete="off"
                           required
                           autofocus />
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fs-6 fw-bold rounded-3 shadow-sm mb-3 transition-btn">
                    XÁC NHẬN & TIẾP TỤC
                </button>
            </form>

            <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-3">
                <a asp-action="ForgotPassword" class="text-decoration-none small text-muted hover-link">
                    <i class="bi bi-arrow-left"></i> Quay lại
                </a>

                <div class="text-end">
                    <span class="text-muted small" id="timerText">Gửi lại sau <b id="countdown">60</b>s</span>
                    <a href="#" class="text-decoration-none small fw-bold text-primary d-none" id="btnResend">
                        Gửi lại mã
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* CSS Tùy chỉnh */
    body {
        background-color: #f8f9fa; /* Nền xám nhẹ cho toàn trang */
    }

    .otp-input {
        font-size: 1.5rem;
        letter-spacing: 0.8em; /* Tạo khoảng cách rộng giữa các số */
        border: 2px solid #e9ecef;
        background-color: #fff;
        transition: all 0.3s ease;
        padding-left: 0.8em; /* Căn chỉnh lại padding do letter-spacing lớn */
    }

        .otp-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
            background-color: #fff;
            outline: none;
        }

        .otp-input::placeholder {
            color: #dee2e6;
            letter-spacing: 0.8em;
        }

    .hover-link:hover {
        color: #0d6efd !important;
        text-decoration: underline !important;
    }

    .transition-btn {
        transition: transform 0.2s;
    }

        .transition-btn:hover {
            transform: translateY(-2px);
        }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- 1. Xử lý đếm ngược ---
        var timeLeft = 60; // Thời gian đếm ngược (giây)
        var countdownEl = document.getElementById("countdown");
        var timerTextEl = document.getElementById("timerText");
        var btnResend = document.getElementById("btnResend");

        // Link action gửi lại mã (Bạn cần tạo Action này trong Controller)
        var resendUrl = '@Url.Action("ResendOTP", "Account", new { email = ViewBag.Email })';

        var timerId = setInterval(function() {
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerTextEl.classList.add("d-none"); // Ẩn text đếm ngược
                btnResend.classList.remove("d-none"); // Hiện nút gửi lại
                btnResend.href = resendUrl; // Gắn link
            } else {
                countdownEl.innerText = timeLeft;
                timeLeft--;
            }
        }, 1000);

        // --- 2. Xử lý Input chỉ cho nhập số ---
        var otpInput = document.querySelector('input[name="otp"]');
        otpInput.addEventListener('input', function (e) {
            // Chỉ giữ lại ký tự số
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    });
</script>